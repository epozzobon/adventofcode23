package main

import (
	"bufio"
	"fmt"
	"log"
	"os"
)

type star struct {
	id int
	r  int
	c  int
}

func in(needle byte, haystack []byte) bool {
	for i := 0; i < len(haystack); i++ {
		if haystack[i] == byte(needle) {
			return true
		}
	}
	return false
}

func readMatrix(filename string) []([]byte) {
	file, err := os.Open(filename)
	if err != nil {
		log.Fatal(err)
	}
	defer file.Close()

	lines := []string{}
	scanner := bufio.NewScanner(file)
	columns := 0
	rows := 0
	for scanner.Scan() {
		rows++
		txt := scanner.Text()
		if len(lines) == 0 {
			columns = len(txt)
		} else {
			if len(txt) != columns {
				panic("Different line lengths")
			}
		}
		lines = append(lines, txt)
	}

	err = scanner.Err()
	if err != nil {
		panic("input read error")
	}

	matrix := make([]([]byte), len(lines))
	for i := 0; i < len(matrix); i++ {
		matrix[i] = make([]byte, len(lines[0]))
		for j := range matrix[i] {
			matrix[i][j] = lines[i][j]
		}
	}

	return matrix
}

func printMatrix(matrix []([]byte)) {
	for i := 0; i < len(matrix); i++ {
		for j := 0; j < len(matrix[i]); j++ {
			fmt.Printf("%c", matrix[i][j])
		}
		fmt.Println()
	}
	fmt.Println()
}

func expandRows(matrix []([]byte)) []([]byte) {
	output := []([]byte){}
	for i := 0; i < len(matrix); i++ {
		reps := 1
		if !in('#', matrix[i]) {
			reps = 2
		}
		for j := 0; j < reps; j++ {
			line := make([]byte, len(matrix[i]))
			copy(line, matrix[i])
			output = append(output, line)
		}
	}
	return output
}

func transpose(matrix []([]byte)) []([]byte) {
	output := make([]([]byte), len(matrix[0]))
	for c := 0; c < len(matrix[0]); c++ {
		output[c] = make([]byte, len(matrix))
	}
	for c := 0; c < len(output); c++ {
		for r := 0; r < len(matrix); r++ {
			output[c][r] = matrix[r][c]
		}
	}
	return output
}

func findStars(matrix []([]byte)) []star {
	output := []star{}
	id := 0
	for r := 0; r < len(matrix); r++ {
		for c := 0; c < len(matrix[r]); c++ {
			if matrix[r][c] == '#' {
				id++
				output = append(output, star{id: id, r: r, c: c})
			}
		}
	}
	return output
}

func abs(a int) int {
	if a < 0 {
		return -a
	}
	return a
}

func main() {

	/* Step 1: input processing */

	matrix := readMatrix("input.txt")

	printMatrix(matrix)
	matrix = expandRows(matrix)
	matrix = transpose(matrix)
	matrix = expandRows(matrix)
	matrix = transpose(matrix)
	printMatrix(matrix)

	stars := findStars(matrix)
	sum1 := 0
	for j := 0; j < len(stars); j++ {
		for i := j + 1; i < len(stars); i++ {
			s1 := stars[j]
			s2 := stars[i]
			vOff := abs(s1.r - s2.r)
			hOff := abs(s1.c - s2.c)
			sum1 += (vOff + hOff)
		}
	}
	fmt.Println(sum1)
}
